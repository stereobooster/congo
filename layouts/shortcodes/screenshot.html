{{ if .Get "src" }}
  {{ $image := .Page.Resources.GetMatch (printf "*%s*" (.Get "src")) }}
  <figure{{ with .Get "class" }} class="{{ . }}"{{ end }}>
    {{- if .Get "href" -}}
      <a href="{{ .Get "href" }}">
    {{- end -}}

    {{ $altText := "" }}
    {{ with .Get "alt" }}
      {{ $altText = . }}
    {{ else }}
      {{ $altText = (.Get "caption") | markdownify | plainify }}
    {{ end }}

    {{ $lazy := $.Page.Site.Params.enableImageLazyLoading | default true }}
    {{ $webp := $.Page.Site.Params.enableImageWebp | default true }}
    {{ $lqip := $.Page.Site.Params.enableImageLqip | default false }}
    {{ partial "picture.html" (dict "img" $image "alt" $altText "x2" true "lazy" $lazy "webp" $webp "lqip" $lqip) }}

    {{- if .Get "href" }}</a>{{ end -}}
    {{- if .Get "caption" -}}
      <figcaption>
        {{- .Get "caption" | markdownify -}}
      </figcaption>
    {{- end }}
  </figure>
{{ end }}
